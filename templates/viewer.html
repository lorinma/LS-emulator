<!DOCTYPE HTML><html lang="en">
<head>
    <title>Ifc webgl renderer</title>
    <meta name='Author' content='Ling Ma- malingreal@gmail.com'>
    <meta name='Keywords' content='WebGl,ifc'>
    <meta charset="utf-8">
    <style type="text/css">
        body {
            background-color: #123345;
            margin: 0px;
            overflow: hidden;
        }
        #cameraInfo {
            position: absolute;
            top: 11%;
            left: 1%;
            width: 400px;
            font-family: Arial;
            background-color: #414042;
            font-size: 12px;
            border-radius: 5px;
            color: #ffffff;
            border: 2px solid #f7941e;
        }

        a {
            color: #f7941e;
            text-decoration: none;
        }

        a:hover {
            color: #ffffff;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="{{
              url_for('static', filename='jquery.js')
              }}">\x3C/script>')
    </script>
</head>

<body>
    <script type=text/javascript>
          $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    </script>
    <div id="container"></div>
    <!--This is the DIV to show the camera position and target point position-->
    <div id="cameraInfo">
        <span>Camera position: </span>
        <div id="caInfo"></div>
        <hr>
        <span>ID</span>
        <div id="taInfo"></div>
        <hr>
        <span>Camera Matrix: </span>
        <div id="maInfo"></div>
    </div>

    <script type="text/javascript" src="{{ url_for('static', filename='') }}three.min.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='') }}OrbitControls.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='') }}stats.min.js"></script>

    <!--The shape.js holds the 3d model data in wavefront-like format, this
    file is generated by pythonocc program-->
    <script type="text/javascript" src="{{ url_for('static', filename='') }}{{
        fid }}.js"></script>

    <script type="text/javascript">
        var camera, scene, renderer, object, stats, container, shape_material;
        var targetRotation = 0;
        var targetRotationOnMouseDown = 0;
        var targetRotationY = 0;
        var targetRotationYOnMouseDown = 0;
        var mouseX = 0;
        var mouseXOnMouseDown = 0;
        var mouseY = 0;
        var mouseYOnMouseDown = 0;
        var moveForward = false;
        var moveBackward = false;
        var moveLeft = false;
        var moveRight = false;
        var moveUp = false;
        var moveDown = false;
        var windowHalfX = window.innerWidth / 2;
        var windowHalfY = window.innerHeight / 2;

        init();
        animate();

        //this function catch the camera parameters and write the camera
        //position and the lookingAt direction to the DIVs
        document.body.addEventListener('keydown', function(e) {
            var caPos=camera.position;

            //this matrix is a coloumn-major matrix representing the pos of
            // the camera which looking at the (0,0,-1) direction
            //mapar=camera.matrix.elements;
            //mapar=camera.matrixworldinverse.elements;
            //$('#madiv').innerHTML=mapar[0]+","+mapar[1]+","+mapar[2]+","+mapar[3]+"<br/>"+mapar[4]+","+mapar[5]+","+mapar[6]+","+mapar[7]+"<br/>"+mapar[8]+","+mapar[9]+","+mapar[10]+","+mapar[11]+"<br/>"+mapar[12]+","+mapar[13]+","+mapar[14]+","+mapar[15];
            var dataToSend = {
                fid:'{{ fid }}',
                x:caPos.x,
                y:caPos.y,
                z:caPos.z
/*
                m0:mapar[0],
                m1:mapar[1],
                m2:mapar[2],
                m3:mapar[3],
                m4:mapar[4],
                m5:mapar[5],
                m6:mapar[6],
                m7:mapar[7],
                m8:mapar[8],
                m9:mapar[9],
                m10:mapar[10],
                m11:mapar[11],
                m12:mapar[12],
                m13:mapar[13],
                m14:mapar[14],
                m15:mapar[15]
                */
            };
            $.getJSON($SCRIPT_ROOT + '/scan',dataToSend,
                function(data) {
                        $("#caInfo").text(data.x);
                        //$("#caInfo").text(data.result);
                        $("#taInfo").text(data.fid);
                        //window.location = $SCRIPT_ROOT + '/pcd/s0';
                        window.open($SCRIPT_ROOT + '/pcd/{{ fid }}');
                }
            );
        });
        function init() {
            container = document.createElement( 'div' );
            document.body.appendChild( container );

            camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 200 );
            camera.position.z = 100;
            controls = new THREE.OrbitControls( camera );
            scene = new THREE.Scene();
            scene.add( new THREE.AmbientLight(0x101010));
            directionalLight = new THREE.DirectionalLight( 0xffffff );
            directionalLight.position.x = 1;
            directionalLight.position.y = 1;
            directionalLight.position.z = 2;
            directionalLight.position.normalize();
            scene.add( directionalLight );
            light1 = new THREE.PointLight( 0xffffff );
            scene.add( light1 );

            phong_material = new THREE.MeshPhongMaterial( { ambient: 0x000000, color: 0xffaa00, specular: 0x555555, shininess: 30 } )
            object = new THREE.Mesh( new Shape(), phong_material);
            object.overdraw = true;
            //object.rotation.x = -1.57/2;
            scene.add( object );
            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setClearColor("#123345");
            renderer.setSize( window.innerWidth, window.innerHeight );
            container.appendChild( renderer.domElement );

            renderer.shadowMapEnabled = true;
            renderer.shadowMapType = THREE.PCFShadowMap;

            stats = new Stats();
            stats.domElement.style.position = 'absolute';
            stats.domElement.style.top = '0px';
            container.appendChild( stats.domElement );
            window.addEventListener( 'resize', onWindowResize, false );

            //test the coordinates of the viewer by add a cube for reference
            // var geometry = new THREE.BoxGeometry( 1, 1, 1 );
            // var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
            // var cube = new THREE.Mesh( geometry, material );
            // cube.position.x=-18.2552;
            // cube.position.y=4.07378;
            // cube.position.z=0;

            // centroid=new THREE.Vector3( 8,17, 0 );
            // cube.matrix.setPosition(centroid);
            // cube.position=centroid;
            // cube.updateMatrix();
            // scene.add( cube );
        }
        function animate() {
                requestAnimationFrame( animate );
                controls.update();
                render();
                stats.update();

        }
        function render() {
               
               renderer.render( scene, camera );
        }
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( window.innerWidth, window.innerHeight );
        }
    </script>
</body>
</html>
